<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mark V2 - Adaptive Reversion</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .status-dot { height: 10px; width: 10px; background-color: #bbb; border-radius: 50%; display: inline-block; }
        .running { background-color: #28a745; }
        .stopped { background-color: #dc3545; }
        .card { margin-bottom: 20px; }
        .pnl-green { color: #28a745; font-weight: bold; }
        .pnl-red { color: #dc3545; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Mark V2 <small class="text-muted" style="font-size: 0.5em">Adaptive Reversion</small></h1>
            <div>
                <span id="status-indicator" class="status-dot"></span>
                <span id="status-text" class="ms-2">Initializing...</span>
                <button class="btn btn-sm btn-success ms-3" onclick="controlBot('start')">Start</button>
                <button class="btn btn-sm btn-danger" onclick="controlBot('stop')">Stop</button>
                <button class="btn btn-sm btn-warning" onclick="controlBot('sweep')">Sweep Dust</button>
            </div>
        </div>

        <!-- Wallet Cards (Restored V1 Layout) -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card text-center text-bg-primary mb-3">
                    <div class="card-body">
                        <h5 class="card-title">Total Balance</h5>
                        <p class="card-text fs-3 mb-0" id="val-total">€...</p>
                        <small class="text-muted">PnL: <span id="pnlVal">---</span></small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center text-bg-secondary mb-3">
                    <div class="card-body">
                        <h5 class="card-title">Available</h5>
                        <p class="card-text fs-3" id="val-available">€...</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center text-bg-success mb-3">
                    <div class="card-body">
                        <h5 class="card-title">Invested</h5>
                        <p class="card-text fs-3" id="val-invested">€...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard Grid -->
        <div class="row">
            <!-- Left Col: Stats & Chart -->
            <div class="col-md-8">
                <!-- Equity Chart -->
                <div class="card">
                    <div class="card-header">Performance Benchmark (vs BTC Hold)</div>
                    <div class="card-body">
                        <canvas id="performanceChart" height="350"></canvas>
                    </div>
                </div>

                <!-- Active Trades -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between">
                        <span>Active Positions</span>
                    </div>
                    <div class="card-body p-0">
                        <table class="table table-striped mb-0 text-center">
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Value</th>
                                    <th>Price / Entry</th>
                                    <th>PnL</th>
                                    <th>DCA Status</th>
                                    <th>Target</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="active-trades-body">
                                <!-- JS Populated -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Right Col: Logs & Settings -->
            <div class="col-md-4">
                 <!-- Settings Mini -->
                 <div class="card">
                    <div class="card-header">Quick Settings</div>
                    <div class="card-body">
                        <div class="input-group mb-2">
                            <span class="input-group-text">Base Order (€)</span>
                            <input type="number" id="setting-base-order" class="form-control" value="50">
                        </div>
                        <div class="input-group mb-2">
                            <span class="input-group-text">Max Budget (€)</span>
                            <input type="number" id="setting-max-budget" class="form-control" value="500">
                            <button class="btn btn-outline-secondary" onclick="saveSettings()">Save</button>
                        </div>
                        <small class="text-muted">Safety Orders: <span id="setting-max-so">3</span> | Scale: 1.5x</small>
                    </div>
                 </div>

                <!-- Recent History -->
                <div class="card">
                    <div class="card-header">Recent Trades</div>
                    <ul class="list-group list-group-flush" id="history-list" style="max-height: 200px; overflow-y: auto;">
                        <!-- JS Populated -->
                    </ul>
                </div>

                <!-- Logs -->
                <div class="card">
                    <div class="card-header">System Logs</div>
                    <div class="card-body bg-black text-monospace p-2" style="height: 300px; overflow-y: auto; font-family: monospace; font-size: 0.8em;" id="logs-container">
                        <!-- JS Populated -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let perfChart = null;

        function updateDashboard() {
            fetch('/api/status')
                .then(r => r.json())
                .then(data => {
                    // Status
                    const dot = document.getElementById('status-indicator');
                    const text = document.getElementById('status-text');
                    if (data.running) {
                        dot.classList.add('running'); dot.classList.remove('stopped');
                    } else {
                        dot.classList.add('stopped'); dot.classList.remove('running');
                    }
                    text.innerText = data.status;

                    // Wallet Cards
                    document.getElementById('val-total').innerText = `€${data.total_balance.toFixed(2)}`;
                    document.getElementById('val-available').innerText = `€${data.available_balance.toFixed(2)}`;
                    document.getElementById('val-invested').innerText = `€${data.invested_amount.toFixed(2)}`;

                    // Total PnL
                    const pnlSpan = document.getElementById('pnlVal');
                    pnlSpan.innerText = `${data.total_pnl.toFixed(2)}€`;
                    pnlSpan.className = data.total_pnl >= 0 ? 'pnl-green' : 'pnl-red';

                    // Active Trades
                    const tbody = document.getElementById('active-trades-body');
                    tbody.innerHTML = '';
                    data.active_trades.forEach(t => {
                        const pnlClass = t.pnl_abs >= 0 ? 'pnl-green' : 'pnl-red';
                        const row = `
                            <tr>
                                <td>${t.symbol}</td>
                                <td>
                                    <div>${t.current_value.toFixed(2)}€</div>
                                    <small class="text-muted">Inv: ${t.total_cost.toFixed(2)}€</small>
                                </td>
                                <td>
                                    <div>${t.current_price.toFixed(4)}</div>
                                    <small class="text-muted">${t.entry_price.toFixed(4)}</small>
                                </td>
                                <td class="${pnlClass}">
                                    ${t.pnl_abs.toFixed(2)}€<br>
                                    <small>${t.pnl_pct.toFixed(2)}%</small>
                                </td>
                                <td>
                                    <span class="badge bg-info text-dark">SO: ${t.safety_orders} / ${data.max_safety_orders}</span><br>
                                    <small class="text-muted">Next: ${t.next_so_price.toFixed(4)}</small>
                                </td>
                                <td>${t.tp_price.toFixed(4)}</td>
                                <td>
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-outline-danger" onclick="forceClose('${t.symbol}')" title="Force Sell (API)">Sell</button>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="forgetTrade('${t.symbol}')" title="Delete from DB (No Sell)">Forget</button>
                                    </div>
                                </td>
                            </tr>
                        `;
                        tbody.innerHTML += row;
                    });

                    // History
                    const histList = document.getElementById('history-list');
                    histList.innerHTML = '';
                    data.history.forEach(h => {
                         const pnlClass = h.pnl_abs >= 0 ? 'pnl-green' : 'pnl-red';
                         histList.innerHTML += `
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                ${h.symbol}
                                <span class="${pnlClass}">${h.pnl_abs.toFixed(2)}€</span>
                            </li>
                         `;
                    });

                    // Logs
                    const logsDiv = document.getElementById('logs-container');
                    logsDiv.innerHTML = data.logs.join('<br>');
                });
        }

        function updateChart() {
            fetch('/api/chart')
                .then(r => {
                    if (!r.ok) throw new Error(r.statusText);
                    return r.json();
                })
                .then(data => {
                    if (!data) return;
                    const ctx = document.getElementById('performanceChart').getContext('2d');

                    // Gradient Fill for Mark V2
                    const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                    gradient.addColorStop(0, 'rgba(40, 167, 69, 0.5)');   // Green opaque
                    gradient.addColorStop(1, 'rgba(40, 167, 69, 0.0)');   // Transparent

                    // Fixed Colors for Benchmarks (Gold, Purple, Blue, Cyan, Magenta, White)
                    const benchColors = ['#ffc107', '#6f42c1', '#0d6efd', '#0dcaf0', '#d63384', '#f8f9fa', '#20c997'];

                    if (!perfChart) {
                        const datasets = [
                            {
                                label: 'Mark V2 (%)',
                                data: data.bot_pct,
                                borderColor: '#28a745',
                                backgroundColor: gradient,
                                fill: true,
                                borderWidth: 3,
                                pointRadius: 0,
                                pointHoverRadius: 5,
                                tension: 0.1
                            }
                        ];

                        // Add Benchmarks
                        let i = 0;
                        if (data.benchmarks) {
                            for (const [coin, series] of Object.entries(data.benchmarks)) {
                                datasets.push({
                                    label: `${coin} Hold (%)`,
                                data: series,
                                borderColor: benchColors[i % benchColors.length],
                                borderDash: [5, 5],
                                borderWidth: 1,
                                pointRadius: 0,
                                pointHoverRadius: 5,
                                tension: 0.1,
                                fill: false
                            });
                            i++;
                            }
                        }

                        perfChart = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: data.dates,
                                datasets: datasets
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                interaction: {
                                    mode: 'index',
                                    intersect: false,
                                },
                                scales: {
                                    x: {
                                        ticks: {
                                            maxTicksLimit: 8
                                        }
                                    },
                                    y: {
                                        // Auto-scale (no suggestedMin/Max)
                                        beginAtZero: false
                                    }
                                }
                            }
                        });
                    } else {
                        perfChart.data.labels = data.dates;
                        perfChart.data.datasets[0].data = data.bot_pct;

                        // Update Benchmarks (assuming whitelist doesn't change runtime)
                        // If we have dynamic number of datasets, easier to just recreate chart or map them carefully.
                        // For simplicity, we'll try to update if lengths match, else recreate.

                        const botDataset = perfChart.data.datasets[0];
                        // Rebuild datasets
                        const newDatasets = [botDataset];
                        let i = 0;
                        if (data.benchmarks) {
                            for (const [coin, series] of Object.entries(data.benchmarks)) {
                                newDatasets.push({
                                    label: `${coin} Hold (%)`,
                                data: series,
                                borderColor: benchColors[i % benchColors.length],
                                borderDash: [5, 5],
                                borderWidth: 1,
                                pointRadius: 0,
                                pointHoverRadius: 5,
                                tension: 0.1,
                                fill: false
                            });
                            i++;
                            }
                        }
                        perfChart.data.datasets = newDatasets;
                        perfChart.update();
                    }
                })
                .catch(e => console.error("Chart Error:", e));
        }

        function controlBot(action) {
            fetch('/api/control', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({action: action})
            }).then(() => updateDashboard());
        }

        function forceClose(symbol) {
            if(confirm('FORCE SELL ' + symbol + ' on Binance?')) {
                fetch('/api/control', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({action: 'close', symbol: symbol})
                });
            }
        }

        function forgetTrade(symbol) {
            if(confirm('FORGET ' + symbol + '? (Deletes from DB only, NO SELL)')) {
                fetch('/api/control', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({action: 'forget', symbol: symbol})
                });
            }
        }

        function saveSettings() {
            const size = document.getElementById('setting-base-order').value;
            const budget = document.getElementById('setting-max-budget').value;
            fetch('/api/settings', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    base_order_size: size,
                    max_budget: budget
                })
            }).then(r => r.json()).then(() => alert('Settings Saved!'));
        }

        // Initial Load
        fetch('/api/settings').then(r=>r.json()).then(d => {
            document.getElementById('setting-base-order').value = d.base_order_size;
            document.getElementById('setting-max-budget').value = d.max_budget;
            document.getElementById('setting-max-so').innerText = d.max_safety_orders;
        });

        setInterval(updateDashboard, 1000);
        setInterval(updateChart, 60000); // Chart update every min
        updateDashboard();
        updateChart();
    </script>
</body>
</html>
