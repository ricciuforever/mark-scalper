<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mark V2 - Adaptive Reversion</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .status-dot { height: 10px; width: 10px; background-color: #bbb; border-radius: 50%; display: inline-block; }
        .running { background-color: #28a745; }
        .stopped { background-color: #dc3545; }
        .card { margin-bottom: 20px; }
        .pnl-green { color: #28a745; font-weight: bold; }
        .pnl-red { color: #dc3545; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Mark V2 <small class="text-muted" style="font-size: 0.5em">Adaptive Reversion</small></h1>
            <div>
                <span id="status-indicator" class="status-dot"></span>
                <span id="status-text" class="ms-2">Initializing...</span>
                <button class="btn btn-sm btn-success ms-3" onclick="controlBot('start')">Start</button>
                <button class="btn btn-sm btn-danger" onclick="controlBot('stop')">Stop</button>
                <button class="btn btn-sm btn-warning" onclick="controlBot('sweep')">Sweep Dust</button>
            </div>
        </div>

        <!-- Dashboard Grid -->
        <div class="row">
            <!-- Left Col: Stats & Chart -->
            <div class="col-md-8">
                <!-- Equity Chart -->
                <div class="card">
                    <div class="card-header">Performance Benchmark (vs BTC Hold)</div>
                    <div class="card-body">
                        <canvas id="performanceChart" height="100"></canvas>
                    </div>
                </div>

                <!-- Active Trades -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between">
                        <span>Active Positions</span>
                        <span id="total-equity-display" class="badge bg-primary">Total Equity: €...</span>
                    </div>
                    <div class="card-body p-0">
                        <table class="table table-striped mb-0 text-center">
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Price / Entry</th>
                                    <th>PnL</th>
                                    <th>DCA Status</th>
                                    <th>Target</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="active-trades-body">
                                <!-- JS Populated -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Right Col: Logs & Settings -->
            <div class="col-md-4">
                 <!-- Settings Mini -->
                 <div class="card">
                    <div class="card-header">Quick Settings</div>
                    <div class="card-body">
                        <div class="input-group mb-2">
                            <span class="input-group-text">Base Order (€)</span>
                            <input type="number" id="setting-base-order" class="form-control" value="50">
                            <button class="btn btn-outline-secondary" onclick="saveSettings()">Save</button>
                        </div>
                        <small class="text-muted">Safety Orders: <span id="setting-max-so">3</span> | Scale: 1.5x</small>
                    </div>
                 </div>

                <!-- Recent History -->
                <div class="card">
                    <div class="card-header">Recent Trades</div>
                    <ul class="list-group list-group-flush" id="history-list" style="max-height: 200px; overflow-y: auto;">
                        <!-- JS Populated -->
                    </ul>
                </div>

                <!-- Logs -->
                <div class="card">
                    <div class="card-header">System Logs</div>
                    <div class="card-body bg-black text-monospace p-2" style="height: 300px; overflow-y: auto; font-family: monospace; font-size: 0.8em;" id="logs-container">
                        <!-- JS Populated -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let perfChart = null;

        function updateDashboard() {
            fetch('/api/status')
                .then(r => r.json())
                .then(data => {
                    // Status
                    const dot = document.getElementById('status-indicator');
                    const text = document.getElementById('status-text');
                    if (data.running) {
                        dot.classList.add('running'); dot.classList.remove('stopped');
                    } else {
                        dot.classList.add('stopped'); dot.classList.remove('running');
                    }
                    text.innerText = data.status;

                    // Equity
                    document.getElementById('total-equity-display').innerText = `Est. Equity: €${data.total_equity.toFixed(2)}`;

                    // Active Trades
                    const tbody = document.getElementById('active-trades-body');
                    tbody.innerHTML = '';
                    data.active_trades.forEach(t => {
                        const pnlClass = t.pnl_abs >= 0 ? 'pnl-green' : 'pnl-red';
                        const row = `
                            <tr>
                                <td>${t.symbol}</td>
                                <td>
                                    <div>${t.current_price.toFixed(4)}</div>
                                    <small class="text-muted">${t.entry_price.toFixed(4)}</small>
                                </td>
                                <td class="${pnlClass}">
                                    ${t.pnl_abs.toFixed(2)}€<br>
                                    <small>${t.pnl_pct.toFixed(2)}%</small>
                                </td>
                                <td>
                                    <span class="badge bg-info text-dark">SO: ${t.safety_orders}</span><br>
                                    <small class="text-muted">Next: ${t.next_so_price.toFixed(4)}</small>
                                </td>
                                <td>${t.tp_price.toFixed(4)}</td>
                                <td>
                                    <button class="btn btn-xs btn-outline-danger" onclick="forceClose('${t.symbol}')">X</button>
                                </td>
                            </tr>
                        `;
                        tbody.innerHTML += row;
                    });

                    // History
                    const histList = document.getElementById('history-list');
                    histList.innerHTML = '';
                    data.history.forEach(h => {
                         const pnlClass = h.pnl_abs >= 0 ? 'pnl-green' : 'pnl-red';
                         histList.innerHTML += `
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                ${h.symbol}
                                <span class="${pnlClass}">${h.pnl_abs.toFixed(2)}€</span>
                            </li>
                         `;
                    });

                    // Logs
                    const logsDiv = document.getElementById('logs-container');
                    logsDiv.innerHTML = data.logs.join('<br>');
                });
        }

        function updateChart() {
            fetch('/api/chart')
                .then(r => r.json())
                .then(data => {
                    const ctx = document.getElementById('performanceChart').getContext('2d');
                    if (!perfChart) {
                        perfChart = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: data.dates,
                                datasets: [
                                    {
                                        label: 'Mark V2 (%)',
                                        data: data.bot_pct,
                                        borderColor: '#28a745',
                                        tension: 0.1
                                    },
                                    {
                                        label: 'BTC Buy & Hold (%)',
                                        data: data.btc_pct,
                                        borderColor: '#ffc107',
                                        borderDash: [5, 5],
                                        tension: 0.1
                                    }
                                ]
                            },
                            options: { responsive: true, maintainAspectRatio: false }
                        });
                    } else {
                        perfChart.data.labels = data.dates;
                        perfChart.data.datasets[0].data = data.bot_pct;
                        perfChart.data.datasets[1].data = data.btc_pct;
                        perfChart.update();
                    }
                });
        }

        function controlBot(action) {
            fetch('/api/control', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({action: action})
            }).then(() => updateDashboard());
        }

        function forceClose(symbol) {
            if(confirm('Force close ' + symbol + '?')) {
                fetch('/api/control', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({action: 'close', symbol: symbol})
                });
            }
        }

        function saveSettings() {
            const size = document.getElementById('setting-base-order').value;
            fetch('/api/settings', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({base_order_size: size})
            }).then(r => r.json()).then(() => alert('Settings Saved!'));
        }

        // Initial Load
        fetch('/api/settings').then(r=>r.json()).then(d => {
            document.getElementById('setting-base-order').value = d.base_order_size;
            document.getElementById('setting-max-so').innerText = d.max_safety_orders;
        });

        setInterval(updateDashboard, 1000);
        setInterval(updateChart, 60000); // Chart update every min
        updateDashboard();
        updateChart();
    </script>
</body>
</html>
